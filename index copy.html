<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MARSHMALLOW SQUAD!</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Arial Rounded MT Bold", "Arial", sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
        overflow: hidden;
        min-height: 100vh;
        touch-action: none;
        user-select: none;
      }

      #gameContainer {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      /* Màn hình bắt đầu */
      #startScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
      }

      .title {
        font-size: 4rem;
        color: #ff69b4;
        text-shadow: 0 0 20px rgba(255, 105, 180, 0.7);
        margin-bottom: 2rem;
        text-align: center;
        animation: titlePulse 2s infinite;
      }

      @keyframes titlePulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .subtitle {
        font-size: 1.5rem;
        color: #ffb6c1;
        margin-bottom: 3rem;
        text-align: justify;
        max-width: 600px;
      }

      .start-btn {
        padding: 15px 40px;
        font-size: 1.5rem;
        background: linear-gradient(135deg, #ff69b4, #ff1493);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        animation: btnGlow 2s infinite;
      }

      @keyframes btnGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 105, 180, 0.8);
        }
      }

      .start-btn:hover {
        transform: scale(1.1);
        animation: none;
        box-shadow: 0 0 40px rgba(255, 105, 180, 1);
      }

      /* Màn hình video */
      #videoScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: black;
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 95;
      }

      #videoPlayer {
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: black;
      }

      .video-controls {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        z-index: 96;
      }
      #videoPlayer::-webkit-media-controls,
      #videoPlayer::-webkit-media-controls-panel,
      #videoPlayer::-webkit-media-controls-play-button,
      #videoPlayer::-webkit-media-controls-timeline,
      #videoPlayer::-webkit-media-controls-current-time-display,
      #videoPlayer::-webkit-media-controls-time-remaining-display,
      #videoPlayer::-webkit-media-controls-timeline-container,
      #videoPlayer::-webkit-media-controls-volume-slider,
      #videoPlayer::-webkit-media-controls-mute-button,
      #videoPlayer::-webkit-media-controls-fullscreen-button,
      #videoPlayer::-webkit-media-controls-overlay-play-button {
        display: none !important;
      }

      /* .skip-btn {
        padding: 10px 30px;
        font-size: 1.2rem;
        background: rgba(255, 105, 180, 0.7);
        color: white;
        border: 2px solid #ff69b4;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .skip-btn:hover {
        background: rgba(255, 105, 180, 1);
        transform: scale(1.05);
      } */

      /* Màn hình bắt đầu cuộc chiến */
      #battleStartScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("");
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 90;
      }

      .battle-title {
        font-size: 4rem;
        color: #ff4500;
        text-shadow: 0 0 20px rgba(255, 69, 0, 0.7);
        margin-bottom: 2rem;
        text-align: center;
        animation: battlePulse 1.5s infinite;
      }
      @keyframes battlePulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      .battle-subtitle {
        font-size: 1.8rem;
        color: #ffb6c1;
        margin-bottom: 3rem;
        text-align: center;
        max-width: 600px;
      }
      .battle-btn {
        padding: 15px 40px;
        font-size: 1.5rem;
        background: linear-gradient(135deg, #ff4500, #ff0000);
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        animation: battleBtnGlow 1.5s infinite;
      }
      @keyframes battleBtnGlow {
        0%,
        100% {
          box-shadow: 0 0 20px rgba(255, 69, 0, 0.5);
        }
        50% {
          box-shadow: 0 0 30px rgba(255, 69, 0, 0.8);
        }
      }
      .battle-btn:hover {
        transform: scale(1.1);
        animation: none;
        box-shadow: 0 0 40px rgba(255, 69, 0, 1);
      }

      /* Game scene */
      #gameScene {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
      }
      #gameCanvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      /* UI Game */
      #gameUI {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
      }
      .health-bar {
        width: 200px;
        height: 25px;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ff69b4;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 10px;
      }
      .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff0000, #ff4500);
        width: 100%;
        transition: width 0.3s ease-out;
      }
      .health-text {
        color: white;
        font-size: 1.1rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }
      .score {
        color: #ffd700;
        font-size: 1.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        margin-top: 10px;
      }
      .combo {
        color: #00ff00;
        font-size: 1.2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        margin-top: 5px;
      }
      .victory-goal {
        color: #ff69b4;
        font-size: 1.3rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        margin-top: 10px;
        font-weight: bold;
      }
      .progress-container {
        width: 300px;
        height: 20px;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ff69b4;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
      }
      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff69b4, #ff1493);
        width: 0%;
        transition: width 0.5s ease-out;
      }

      /* Controls */
      #controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        display: flex;
        gap: 15px;
        z-index: 10;
      }
      .control-btn {
        padding: 12px 25px;
        background: rgba(255, 105, 180, 0.7);
        border: 2px solid #ff69b4;
        border-radius: 10px;
        color: white;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s;
      }
      .control-btn:hover {
        background: rgba(255, 105, 180, 1);
        transform: scale(1.05);
      }
      .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .control-btn.active {
        background: orange;
        transform: scale(1.1);
      }

      /* Game Over */
      #gameOver {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 20;
      }
      .game-over-text {
        font-size: 3rem;
        color: #ff69b4;
        margin-bottom: 2rem;
        animation: gameOverPulse 1.5s infinite;
      }
      @keyframes gameOverPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      .final-score {
        font-size: 2rem;
        color: #ffd700;
        margin-bottom: 2rem;
      }

      /* Victory Screen */
      #victoryScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 25;
      }
      .victory-title {
        font-size: 4rem;
        color: #ffd700;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        margin-bottom: 2rem;
        animation: victoryPulse 2s infinite;
      }
      @keyframes victoryPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      .victory-message {
        font-size: 1.8rem;
        color: #ffb6c1;
        margin-bottom: 2rem;
        text-align: center;
        max-width: 600px;
      }

      /* Mobile Controls */
      #mobileControls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: none;
        flex-direction: column;
        gap: 10px;
        z-index: 10;
      }
      .mobile-btn {
        width: 60px;
        height: 60px;
        background: rgba(255, 105, 180, 0.7);
        border: 2px solid #ff69b4;
        border-radius: 50%;
        color: white;
        font-size: 1.2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        touch-action: manipulation;
      }

      /* Combo Effect */
      .combo-popup {
        position: absolute;
        font-size: 2rem;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        animation: comboFloat 1s ease-out forwards;
        z-index: 15;
      }
      @keyframes comboFloat {
        0% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) scale(1.5);
          opacity: 0;
        }
      }

      /* Victory Effect */
      .victory-particle {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ffd700;
        animation: victoryFloat 3s ease-out forwards;
        z-index: 15;
      }
      @keyframes victoryFloat {
        0% {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
        100% {
          transform: translateY(-200px) scale(0);
          opacity: 0;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .title {
          font-size: 2.5rem;
        }
        .subtitle {
          font-size: 1.2rem;
          padding: 0 20px;
        }
        .battle-title {
          font-size: 2.5rem;
        }
        .battle-subtitle {
          font-size: 1.3rem;
          padding: 0 20px;
        }
        .victory-title {
          font-size: 2.5rem;
        }
        .victory-message {
          font-size: 1.3rem;
          padding: 0 20px;
        }
        #mobileControls {
          display: flex;
        }
        #controls {
          display: none;
        }
        #videoPlayer {
          width: 95%;
          height: 60%;
        }
      }

      #startMenu {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("./assets/start.png");
        background-size: cover;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 80;
      }

      .start {
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: none;
        border: none;
        color: transparent;
      }

      #mainGame {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("./assets/main_menu.png");
        background-size: cover;
        display: none;
        flex-direction: row;
        z-index: 70;
      }

      #menu-optiones {
        position: absolute;
        top: 0;
        right: 0;
        display: flex;
        gap: 20px;
        z-index: 71;
      }

      #battleButton,
      #characterButton {
        width: 100px;
        height: 100px;
        background: none;
        border: none;
        transform: scale(1);
        transition: transform 0.3s ease;
      }

      #battleButton:hover,
      #characterButton:hover {
        transform: scale(1.1);
        transition: transform 0.3s ease;
        cursor: pointer;
      }

      #characterScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #4f5277;
        z-index: 75;
      }

      #tall,
      #hard {
        position: absolute; /* để dùng left/right/top */
        width: 500px;
        height: 500px;
        padding: 0;
        border: none;
        background: none;
        display: inline-flex; /* canh giữa nội dung */
        align-items: center;
        justify-content: center;
        overflow: hidden; /* nếu ảnh lớn hơn thì không phình nút */
        transform: scale(1);
        transition: transform 0.3s ease;
      }

      #tall {
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
      }
      #hard {
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
      }

      #tall img,
      #hard img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* hoặc cover nếu muốn “đầy” */
        display: block;
      }

      #tall:hover,
      #hard:hover {
        transform: translateY(-50%) scale(1.1);
        transition: transform 0.3s ease;
        cursor: pointer;
      }

      #hard_stats,
      #tall_stats {
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 500px;
        height: 200px;
        z-index: 76;
      }

      #tall_stats[hidden],
      #hard_stats[hidden] {
        display: none !important;
      }

      #stats1,
      #weapon1 {
        display: inline-block;
        width: 200px;
        height: 200px;
        margin: 20px;
        padding: 10px;
        border: 2px solid white;
        border-radius: 10px;
        text-align: center;
        position: relative;
      }
      #stats1 h3,
      #weapon1 h1 {
        margin-bottom: 10px;
        font-size: 1.5rem;
        color: #ff69b4;
        position: relative;
      }
      #stats1 h5,
      #weapon1 h5 {
        margin: 5px 0;
        font-size: 1.2rem;
        color: white;
        position: relative;
      }
      #stats1 img,
      #weapon1 img {
        width: 50px;
        height: 50px;
        vertical-align: middle;
        margin-right: 8px;
        position: relative;
      }
      #stats2,
      #weapon2 {
        display: inline-block;
        width: 200px;
        height: 200px;
        margin: 20px;
        padding: 10px;
        border: 2px solid white;
        border-radius: 10px;
        text-align: center;
        position: relative;
      }
      #stats2 h3,
      #weapon2 h1 {
        margin-bottom: 10px;
        font-size: 1.5rem;
        color: #ff69b4;
        position: relative;
      }
      #stats2 h5,
      #weapon2 h5 {
        margin: 5px 0;
        font-size: 1.2rem;
        color: white;
        position: relative;
      }
      #stats2 img,
      #weapon2 img {
        width: 50px;
        height: 50px;
        vertical-align: middle;
        margin-right: 8px;
        position: relative;
      }

      .type-line {
        /* nên dùng font monospace để steps(…) khớp từng ký tự */
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas,
          "Liberation Mono", monospace;
        width: 1098ch; /* = số ký tự của dòng */
        white-space: nowrap;
        overflow: hidden;
        border-right: 3px solid #ff69b4; /* con trỏ nhấp nháy */
        animation: typing 2.8s steps(20, end), caret 0.6s step-end infinite;
      }
      @keyframes typing {
        from {
          width: 0;
        }
        to {
          width: 20ch;
        }
      }
      @keyframes caret {
        50% {
          border-color: transparent;
        }
      }

      /* Lưới 3 cột: trái (Tall) – giữa (title + info) – phải (Hard) */
      .char-grid {
        position: absolute;
        inset: 0;
        display: grid;
        grid-template-columns: 1fr clamp(340px, 40vw, 520px) 1fr;
        grid-template-rows: auto auto auto; /* title, stats, weapon */
        grid-template-areas:
          "left  title  right"
          "left  stats  right"
          "left  weapon right";
        align-items: center;
        justify-items: center;
        gap: 24px;
        padding: 24px 32px;
      }

      /* Vị trí từng ô trong lưới */
      .char-title {
        grid-area: title;
        text-align: center;
        font-weight: 800;
        font-size: clamp(28px, 4vw, 48px);
        line-height: 1;
        color: #fff;
      }

      #tall {
        grid-area: left;
        align-self: end;
      }
      #hard {
        grid-area: right;
        align-self: end;
      }

      .info-col {
        grid-column: 2;
        width: 100%;
        display: grid;
        gap: 18px;
      }
      #tall_stats {
        grid-row: 2 / span 2;
        grid-template-rows: auto auto;
      } /* stats + weapon */
      #hard_stats {
        grid-row: 2 / span 2;
        grid-template-rows: auto auto;
      }

      /* Thẻ card trắng bo tròn như hình */
      .card {
        background: #fff;
        color: #111;
        border: 3px solid #000;
        border-radius: 20px;
        padding: 16px 18px;
        width: 100%;
        box-shadow: 0 10px 0 rgba(0, 0, 0, 0.18); /* viền đậm ở dưới như vẽ tay */
      }
      .card h3 {
        margin-bottom: 8px;
      }
      .card p {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 20px;
      }

      /* Icon nhỏ trong dòng stats */
      .icon {
        width: 20px;
        height: 20px;
        object-fit: contain;
      }

      /* Ảnh vũ khí to trong card */
      .weapon-img {
        width: 65%;
        height: auto;
        display: block;
        margin: 6px auto 0;
      }

      /* 2 nút nhân vật bên trái/phải là ảnh lớn, có đổ bóng */
      .char-side {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
      }
      .char-side img {
        width: min(28vw, 360px);
        height: auto;
        display: block;
        filter: drop-shadow(0 18px 24px rgba(0, 0, 0, 0.35));
        transition: transform 0.2s ease;
      }
      .char-side:hover img {
        transform: translateY(-4px) scale(1.02);
      }

      /* Nút home góc phải trên (tuỳ chọn) */
      .home-btn {
        position: absolute;
        top: 14px;
        right: 14px;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.35);
        color: #fff;
        border: 2px solid #fff;
      }

      /* Bắt hidden phải ẩn thật (nếu trước đó bạn set display:flex) */
      #tall_stats[hidden],
      #hard_stats[hidden] {
        display: none !important;
      }

      /* Mobile: thu nhỏ ảnh 2 bên, info chiếm rộng hơn */
      @media (max-width: 768px) {
        .char-grid {
          grid-template-columns: 1fr clamp(280px, 70vw, 520px) 1fr;
          gap: 16px;
        }
        .char-side img {
          width: min(34vw, 260px);
        }
      }

      /* === Two-Phase Boss UI === */
      #bossWarning{
        position:absolute; inset:0; display:none; align-items:center; justify-content:center;
        font-size:4vw; font-weight:900; color:#fff;
        text-shadow:0 0 20px #f00, 0 0 40px #f00;
        background:rgba(0,0,0,.4); z-index:9999;
        animation:pulseWarn .6s ease-in-out infinite alternate;
      }
      @keyframes pulseWarn{from{transform:scale(1);opacity:.9}to{transform:scale(1.05);opacity:1}}
      #bossHP{
        position:absolute; left:50%; transform:translateX(-50%);
        top:12px; width:64%; height:16px; display:none;
        background:rgba(255,255,255,.15); border:2px solid rgba(255,255,255,.4);
        border-radius:10px; overflow:hidden; z-index:9999;
      }
      #bossHPFill{height:100%; width:100%; background:linear-gradient(90deg,#ff4d4d,#ff1a1a)}

    </style>
  </head>
  <body>
    <div id="gameContainer">
      <!-- Màn hình bắt đầu -->
      <div id="startScreen">
        <div>
          <h1 class="title">The Story</h1>
          <p class="subtitle">
            Near the edge of the Sun, there lies a whimsical planet called
            Cotton Cloudia. From afar, it looks like a giant pink puff drifting
            gently through the cosmos. On its surface, countless sweet little
            beings made of candy, cakes, and sugar live happily in peace. It all
            seemed like eternal sweetness… until the Sun began to grow unstable.
            Streams of powerful energy burst out, heating the planet’s surface.
            Some candy buildings started to melt, and even tiny sugarfolk could
            no longer withstand the scorching heat. Among the candy community
            was a trio of marshmallow friends: Vanilla Puff, Choco Chipster, and
            Banana Crepe. But disaster struck—during a camping trip under the
            starlit skies, the Sun suddenly erupted with a blast of energy.
            Banana Crepe was scorched and forever changed, his cheerful spirit
            twisted into darkness. From a loyal friend, he became a villain,
            driven by the desire to harness the Sun’s power and rule everything.
            Facing this threat, Vanilla Puff and Choco Chipster made a vow: to
            stop their fallen friend and to protect Cotton Cloudia from the
            raging fury of space weather.
          </p>
          <button class="start-btn" onclick="playVideo1()">
            Start the game
          </button>
        </div>
      </div>

      <!-- Màn hình video -->
      <div id="videoScreen">
        <video id="videoPlayer" controls>
          Video is not supported by your browser.
        </video>
        <!-- <div class="video-controls">
          <button class="skip-btn" id="skipVideoBtn" onclick="skipVideo()">
            Bỏ Qua
          </button>
        </div> -->
      </div>

      <!-- Màn hình start menu-->
      <div id="startMenu">
        <button class="start" onclick="playCutscene()">PLay</button>
      </div>

      <!--Màn hình chính-->
      <div id="mainGame">
        <div id="menu-options">
          <button id="battleButton" onclick="showBattleStartScreen()">
            <img src="./assets/battle.png" />
          </button>
          <button id="characterButton" onclick="showCharacterMenu()">
            <img src="./assets/character.png" />
          </button>
        </div>
      </div>

      <!-- Màn hình bắt đầu cuộc chiến -->
      <div id="battleStartScreen">
        <h1 class="battle-title">START THE BATTLE!</h1>
        <p class="battle-subtitle">are you ready to save the world??</p>
        <button class="battle-btn" onclick="startBattle()">Ready!!</button>
      </div>

      <!--Màn hình nhân vật-->
      <div id="characterScreen" class="char-grid" style="display: none">
        <!-- Trái: Tall -->
        <button id="tall" class="char-side">
          <img src="./assets/tall.png" alt="Tall" />
        </button>

        <!-- Tiêu đề ở giữa trên -->
        <h1 id="charName" class="char-title">Vanilla</h1>

        <!-- Cụm thông tin ở giữa (chỉ một trong 2 khối dưới sẽ hiện) -->
        <div id="tall_stats" class="info-col" hidden>
          <div id="stats1" class="card">
            <h3>STATS:</h3>
            <p>
              10
              <img
                class="icon"
                src="https://static.vecteezy.com/system/resources/previews/016/589/188/original/heart-8bit-pixel-png.png"
                alt=""
              />
            </p>
            <p>10 <img class="icon" src="./assets/battle.png" alt="" /></p>
          </div>
          <div id="weapon1" class="card">
            <h3>WEAPON:</h3>
            <img class="weapon-img" src="./assets/gun.png" alt="" />
          </div>
        </div>

        <div id="hard_stats" class="info-col" hidden>
          <div id="stats2" class="card">
            <h3>STATS:</h3>
            <p>
              10
              <img
                class="icon"
                src="https://static.vecteezy.com/system/resources/previews/016/589/188/original/heart-8bit-pixel-png.png"
                alt=""
              />
            </p>
            <p>10 <img class="icon" src="./assets/battle.png" alt="" /></p>
          </div>
          <div id="weapon2" class="card">
            <h3>WEAPON:</h3>
            <img class="weapon-img" src="./assets/staff.png" alt="" />
          </div>
        </div>

        <!-- Phải: Hard -->
        <button id="hard" class="char-side">
          <img src="./assets/hard.png" alt="Hard" />
        </button>

        <!-- (tuỳ chọn) nút Home góc phải trên -->
        <button id="btnHome" class="home-btn" title="Home">⌂</button>
      </div>

      <!-- Màn hình game -->
      <div id="gameScene">
        <canvas id="gameCanvas"></canvas>

        <!-- UI Game -->
        <div id="gameUI">
          <div class="health-bar">
            <div class="health-fill" id="healthBar"></div>
          </div>
          <div class="health-text" id="healthText">HP: 100/100</div>
          <div class="score" id="score">Score: 0</div>
          <div class="combo" id="combo">Combo: 0x</div>
          <div class="victory-goal" id="victoryGoal">
            Objective: 0/200 Score
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <!-- Điều khiển Desktop -->
        <div id="controls">
          <button class="control-btn" id="attackBtn" onclick="playerAttack()">
            Attack (Space)
          </button>
          <button class="control-btn" id="shieldBtn" onclick="activateShield()">
            Shield (R)
          </button>
          <button class="control-btn" id="specialBtn" onclick="specialAttack()">
            Special (T)
          </button>
        </div>

        <!-- Điều khiển Mobile -->
        <div id="mobileControls">
          <button
            class="mobile-btn"
            id="mobileShield"
            onclick="activateShield()"
          >
            S
          </button>
          <button
            class="mobile-btn"
            id="mobileSpecial"
            onclick="specialAttack()"
          >
            D
          </button>
          <button class="mobile-btn" id="mobileAttack" onclick="playerAttack()">
            ⚡
          </button>
        </div>
      </div>

      <!-- Màn hình kết thúc -->
      <div id="gameOver">
        <div class="game-over-text" id="gameOverText">Failed</div>
        <div class="final-score" id="finalScore">Score: 0</div>
        <button class="start-btn" onclick="restartGame()">Restart?</button>
      </div>

      <!-- Màn hình chiến thắng -->
      <div id="victoryScreen">
        <div class="victory-title">Victory!!</div>
        <div class="victory-message" id="victoryMessage">
          You have achived 200 scores and saved Cotton Cloudia!
        </div>
        <div class="final-score" id="victoryScore">Score: 0</div>
        <button class="start-btn" onclick="playVideo2()">
          End the madness
        </button>
      </div>
    </div>

    <script>
      // ========== KHAI BÁO BIẾN ==========
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const videoPlayer = document.getElementById("videoPlayer");
      const skipVideoBtn = document.getElementById("skipVideoBtn");

      // Kích thước canvas
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      // ========== LOAD HÌNH ẢNH ==========
      const images = {};
      const imageSources = {
        player: "./assets/UFO.png",
        bullet: "./assets/bullet.png",
        bulletSpecial: "./assets/bullet_special.png",
        enemyMinion: "./assets/nom.png",
        enemyBanana: "./assets/big nom.png",
        explosion: "./assets/explosion.png",
        boss: "./assets/boss.png",
      };

      function loadImages(callback) {
        let loaded = 0;
        const keys = Object.keys(imageSources);
        const total = keys.length;
        keys.forEach((key) => {
          const img = new Image();
          img.src = imageSources[key];
          img.onload = () => {
            images[key] = img;
            loaded++;
            if (loaded === total && callback) callback();
          };
          img.onerror = () => {
            console.warn("Không tải được ảnh:", imageSources[key]);
            loaded++;
            if (loaded === total && callback) callback();
          };
        });
      }

      // Game state
      const gameState = {
        running: false,
        keys: {},
        player: {
          x: 100,
          y: canvas.height / 2,
          width: 80,
          height: 50,
          speed: 8,
          velocityX: 0,
          velocityY: 0,
          health: 100,
          maxHealth: 100,
          shield: false,
          shieldTime: 0,
          lastShot: 0,
          shootDelay: 150,
          invulnerable: 0,
        },
        enemies: [],
        projectiles: [],
        enemyProjectiles: [],
        particles: [],
        stars: [],
        score: 0,
        combo: 0,
        comboTimeout: null,
        lastComboTime: 0,
        victoryPoints: 200,
        level: 1,
        lastTime: 0,
        deltaTime: 0,
        enemySpawnRate: 2000,
        lastEnemySpawn: 0,
      };

      // ========== HÀM KHỞI TẠO ==========
      function initGame() {
        // Tạo ngôi sao nền
        gameState.stars = [];
        for (let i = 0; i < 150; i++) {
          gameState.stars.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            size: Math.random() * 2 + 1,
            speed: Math.random() * 0.5 + 0.1,
            brightness: Math.random() * 0.5 + 0.5,
          });
        }
      }

      let currentVideoType = null;
      function playVideo1() {
        document.getElementById("startScreen").style.display = "none";
        document.getElementById("videoScreen").style.display = "flex";
        videoPlayer.src = "./assets/intro.mp4";
        currentVideoType = "intro";
        videoPlayer.controls = false;
        videoPlayer.removeAttribute("controls");
        videoPlayer.play().catch(() => showPlayButton());
        // skipVideoBtn.style.display = "none";
        // setTimeout(() => {
        //   skipVideoBtn.style.display = "block";
        // }, 3000);
        videoPlayer.onended = function () {
          showStartMenu();
        };
        videoPlayer.oncontextmenu = function (e) {
          e.preventDefault();
          return false;
        };
      }

      function playVideo2() {
        document.getElementById("victoryScreen").style.display = "none";
        document.getElementById("videoScreen").style.display = "flex";
        videoPlayer.src = "./assets/ending.mp4";
        currentVideoType = "victory";
        videoPlayer.controls = false;
        videoPlayer.removeAttribute("controls");
        videoPlayer.play().catch(() => showPlayButton());
        // skipVideoBtn.style.display = "none";
        // setTimeout(() => {
        //   skipVideoBtn.style.display = "block";
        // }, 3000);
        videoPlayer.oncontextmenu = function (e) {
          e.preventDefault();
          return false;
        };
      }

      function playCutscene() {
        document.getElementById("startMenu").style.display = "none";
        document.getElementById("videoScreen").style.display = "flex";
        videoPlayer.src = "./assets/cutscene.mp4";
        currentVideoType = "cutscene";
        videoPlayer.controls = false;
        videoPlayer.removeAttribute("controls");
        videoPlayer.play().catch(() => showPlayButton());
        // skipVideoBtn.style.display = "none";
        // setTimeout(() => {
        //   skipVideoBtn.style.display = "block";
        // }, 3000);
        videoPlayer.onended = function () {
          showMainMenu();
        };
        videoPlayer.oncontextmenu = function (e) {
          e.preventDefault();
          return false;
        };
      }

      function playCredits() {
        document.getElementById("videoScreen").style.display = "flex";
        videoPlayer.src = "./assets/credits.mp4";
        currentVideoType = "credits";
        videoPlayer.controls = false;
        videoPlayer.removeAttribute("controls");
        videoPlayer.muted = true; // bật mute để đa số trình duyệt cho autoplay
        videoPlayer.setAttribute("muted", ""); // iOS/Safari đôi khi cần
        videoPlayer.setAttribute("playsinline", ""); // để phát inline trên iOS
        videoPlayer.play().catch(() => showPlayButton());
        // skipVideoBtn.style.display = "none";
        // setTimeout(() => {
        //   skipVideoBtn.style.display = "block";
        // }, 3000);
        videoPlayer.onended = function () {
          returnToStart();
        };
        videoPlayer.oncontextmenu = function (e) {
          e.preventDefault();
          return false;
        };
      }

      // Hàm hiển thị nút play nếu autoplay bị chặn
      function showPlayButton() {
        const playBtn = document.createElement("button");
        playBtn.textContent = "BẮT ĐẦU VIDEO";
        Object.assign(playBtn.style, {
          position: "absolute",
          top: "50%",
          left: "50%",
          transform: "translate(-50%, -50%)",
          padding: "15px 30px",
          fontSize: "1.5rem",
          background: "linear-gradient(135deg, #ff69b4, #ff1493)",
          color: "white",
          border: "none",
          borderRadius: "25px",
          cursor: "pointer",
          zIndex: 97,
        });
        playBtn.onclick = function () {
          videoPlayer.play();
          playBtn.remove();
        };
        document.getElementById("videoScreen").appendChild(playBtn);
      }

      // function skipVideo() {
      //   videoPlayer.pause();
      //   videoPlayer.currentTime = 0;
      //   if (currentVideoType === "intro") showStartMenu();
      //   else if (currentVideoType === "victory") returnToStart();
      //   else if (currentVideoType === "cutscene") showMainMenu();
      //   currentVideoType = null;
      // }

      function char1stats() {
        document.getElementById("tall_stats").hidden = false;
        document.getElementById("hard_stats").hidden = true;
      }
      function char2stats() {
        document.getElementById("hard_stats").hidden = false;
        document.getElementById("tall_stats").hidden = true;
      }

      function showMainMenu() {
        // Ẩn mọi màn có thể còn mở
        [
          "videoScreen",
          "startScreen",
          "startMenu",
          "characterScreen",
          "battleStartScreen",
          "gameOver",
          "victoryScreen",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        });

        // Hiện Main Game
        const mg = document.getElementById("mainGame");
        if (mg) mg.style.display = "flex";
      }

      function showStartMenu() {
        document.getElementById("videoScreen").style.display = "none";
        document.getElementById("startMenu").style.display = "flex";
      }

      function showCharacterMenu() {
        document.getElementById("mainGame").style.display = "none";
        document.getElementById("characterScreen").style.display = "flex";
      }

      function showBattleStartScreen() {
        // Ẩn tất cả màn có thể đang mở
        const hide = (id) => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        };
        hide("videoScreen");
        hide("startScreen");
        hide("startMenu");
        hide("mainGame");

        // Hiện màn chuẩn bị chiến đấu
        const bs = document.getElementById("battleStartScreen");
        if (bs) bs.style.display = "flex";
      }

      function startBattle() {
        // Ẩn hết các màn khác để khỏi đè
        [
          "battleStartScreen",
          "startMenu",
          "mainGame",
          "videoScreen",
          "startScreen",
        ].forEach((id) => {
          const el = document.getElementById(id);
          if (el) el.style.display = "none";
        });

        document.getElementById("gameScene").style.display = "block";
        loadImages(() => {
          initGame();
          gameState.running = true;
          window.addEventListener("keydown", handleKeyDown);
          window.addEventListener("keyup", handleKeyUp);
          canvas.addEventListener("touchstart", handleTouchStart);
          canvas.addEventListener("touchmove", handleTouchMove);
          canvas.addEventListener("touchend", handleTouchEnd);
          requestAnimationFrame(gameLoop);
        });
      }

      function returnToStart() {
        gameState.running = false;
        gameState.player.health = 100;
        gameState.player.x = 100;
        gameState.player.y = canvas.height / 2;
        gameState.player.velocityX = 0;
        gameState.player.velocityY = 0;
        gameState.enemies = [];
        gameState.projectiles = [];
        gameState.enemyProjectiles = [];
        gameState.particles = [];
        gameState.score = 0;
        gameState.combo = 0;
        gameState.level = 1;
        gameState.enemySpawnRate = 2000;
        gameState.lastEnemySpawn = 0;

        document.getElementById("videoScreen").style.display = "none";
        document.getElementById("startScreen").style.display = "flex";
        updateUI();
      }

      function restartGame() {
        document.getElementById("gameOver").style.display = "none";
        document.getElementById("gameScene").style.display = "block";
        gameState.running = true;
        gameState.player.health = 100;
        gameState.player.x = 100;
        gameState.player.y = canvas.height / 2;
        gameState.player.velocityX = 0;
        gameState.player.velocityY = 0;
        gameState.enemies = [];
        gameState.projectiles = [];
        gameState.enemyProjectiles = [];
        gameState.particles = [];
        gameState.score = 0;
        gameState.combo = 0;
        gameState.level = 1;
        gameState.enemySpawnRate = 2000;
        updateUI();
        requestAnimationFrame(gameLoop);
      }

      function char1stats(){
        // Tall
        document.getElementById("tall_stats").hidden = false;
        document.getElementById("hard_stats").hidden = true;
        document.getElementById("charName").textContent = "Vanilla";
      }
      function char2stats(){
        // Hard
        document.getElementById("hard_stats").hidden = false;
        document.getElementById("tall_stats").hidden = true;
        document.getElementById("charName").textContent = "Chocolate"; // đổi tên tùy bạn
      }

      // Gắn vào click của 2 nút 2 bên
      document.getElementById("tall")?.addEventListener("click", char1stats);
      document.getElementById("hard")?.addEventListener("click", char2stats);

      // ========== INPUT HANDLING ==========
      function handleKeyDown(e) {
        gameState.keys[e.key] = true;
        if (e.key === " ") e.preventDefault();
        if (e.key === "r" || e.key === "R") {
          activateShield();
          document.getElementById("shieldBtn").classList.add("active");
        }
        if (e.key === "t" || e.key === "T") {
          specialAttack();
          document.getElementById("specialBtn").classList.add("active");
        }
      }
      function handleKeyUp(e) {
        gameState.keys[e.key] = false;
        if (e.key.toLowerCase() === "r")
          document.getElementById("shieldBtn").classList.remove("active");
        if (e.key.toLowerCase() === "t")
          document.getElementById("specialBtn").classList.remove("active");
      }
      function handleTouchStart(e) {
        e.preventDefault();
        const t = e.touches[0];
        gameState.touchX = t.clientX;
        gameState.touchY = t.clientY;
      }
      function handleTouchMove(e) {
        e.preventDefault();
        if (!gameState.touchX || !gameState.touchY) return;
        const t = e.touches[0];
        const dx = t.clientX - gameState.touchX;
        const dy = t.clientY - gameState.touchY;
        const p = gameState.player;
        p.x = Math.max(0, Math.min(canvas.width - p.width, p.x + dx));
        p.y = Math.max(0, Math.min(canvas.height - p.height, p.y + dy));
        gameState.touchX = t.clientX;
        gameState.touchY = t.clientY;
      }
      function handleTouchEnd() {
        gameState.touchX = null;
        gameState.touchY = null;
      }

      // ========== GAME LOOP ==========
      function gameLoop(timestamp) {
        gameState.deltaTime = timestamp - gameState.lastTime;
        gameState.lastTime = timestamp;
        ctx.fillStyle = "#0a0a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (gameState.running) {
          drawStars();
          handleContinuousInput();
          spawnEnemies();
          updatePlayer();
          updateEnemies();
          updateProjectiles();
          updateParticles();
          checkCollisions();
          checkVictory();
          updateUI();
          updateCombo();
        }
        requestAnimationFrame(gameLoop);
      }

      function handleContinuousInput() {
        const p = gameState.player;
        const speed = p.speed * (gameState.deltaTime / 16);
        p.velocityX = 0;
        p.velocityY = 0;
        if (gameState.keys["ArrowUp"] || gameState.keys["w"])
          p.velocityY = -speed;
        if (gameState.keys["ArrowDown"] || gameState.keys["s"])
          p.velocityY = speed;
        if (gameState.keys["ArrowLeft"] || gameState.keys["a"])
          p.velocityX = -speed;
        if (gameState.keys["ArrowRight"] || gameState.keys["d"])
          p.velocityX = speed;
        p.x = Math.max(0, Math.min(canvas.width - p.width, p.x + p.velocityX));
        p.y = Math.max(
          0,
          Math.min(canvas.height - p.height, p.y + p.velocityY)
        );
        if (
          (gameState.keys[" "] || gameState.keys["Spacebar"]) &&
          Date.now() - p.lastShot > p.shootDelay
        ) {
          playerAttack();
          p.lastShot = Date.now();
        }
        if (p.invulnerable > 0) p.invulnerable--;
      }

      // ========== VẼ ĐỐI TƯỢNG ==========
      function drawStars() {
        ctx.fillStyle = "white";
        gameState.stars.forEach((star) => {
          ctx.globalAlpha = star.brightness;
          ctx.fillRect(star.x, star.y, star.size, star.size);
          star.x -= star.speed;
          if (star.x < -star.size) {
            star.x = canvas.width;
            star.y = Math.random() * canvas.height;
          }
        });
        ctx.globalAlpha = 1;
      }

      function drawPlayer() {
        const p = gameState.player;
        if (images.player) {
          ctx.drawImage(images.player, p.x, p.y, p.width, p.height);
        } else {
          // fallback hình chữ nhật nếu ảnh chưa kịp load
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(p.x, p.y, p.width, p.height);
        }
        if (p.shield) {
          ctx.strokeStyle = "#00bfff";
          ctx.lineWidth = 3;
          ctx.globalAlpha = 0.6;
          ctx.beginPath();
          ctx.arc(p.x + p.width / 2, p.y + p.height / 2, 60, 0, Math.PI * 2);
          ctx.stroke();
          ctx.globalAlpha = 1;
        }
      }

      function drawEnemy(enemy) {
        if (enemy.type === "banana" && images.enemyBanana) {
          ctx.drawImage(
            images.enemyBanana,
            enemy.x,
            enemy.y,
            enemy.width,
            enemy.height
          );
        } else if (images.enemyMinion) {
          ctx.drawImage(
            images.enemyMinion,
            enemy.x,
            enemy.y,
            enemy.width,
            enemy.height
          );
        } else {
          ctx.fillStyle = "#ff4500";
          ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
        }
      }

      // ========== UPDATE LOGIC ==========
      function updatePlayer() {
        drawPlayer();
        if (gameState.player.shieldTime > 0) {
          gameState.player.shieldTime--;
          if (gameState.player.shieldTime <= 0) gameState.player.shield = false;
        }
      }

      function spawnEnemies() {
        const now = Date.now();
        if (now - gameState.lastEnemySpawn > gameState.enemySpawnRate) {
          const types =
            gameState.score > 150
              ? ["minion", "banana", "minion", "banana"]
              : ["minion", "minion", "minion", "banana"];
          const type = types[Math.floor(Math.random() * types.length)];
          gameState.enemies.push({
            x: canvas.width,
            y: Math.random() * (canvas.height - 60),
            width: type === "banana" ? 90 : 70,
            height: type === "banana" ? 60 : 45,
            speed: type === "banana" ? 3 : 5,
            type,
          });
          gameState.lastEnemySpawn = now;
          if (gameState.enemySpawnRate > 800) gameState.enemySpawnRate -= 10;
        }
      }

      function updateEnemies() {
        for (let i = gameState.enemies.length - 1; i >= 0; i--) {
          const enemy = gameState.enemies[i];
          enemy.x -= enemy.speed * (gameState.deltaTime / 16);
          if (enemy.x + enemy.width < 0) {
            gameState.enemies.splice(i, 1);
            continue;
          }
          drawEnemy(enemy);
          const shootChance = gameState.score > 150 ? 0.03 : 0.02;
          if (Math.random() < shootChance * (gameState.deltaTime / 16))
            enemyShoot(enemy);
        }
      }

      function updateProjectiles() {
        // Player projectiles
        for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
          const proj = gameState.projectiles[i];
          proj.x += proj.speed * (gameState.deltaTime / 16);
          if (proj.x > canvas.width) {
            gameState.projectiles.splice(i, 1);
            continue;
          }
          const sprite =
            proj.type === "special" ? images.bulletSpecial : images.bullet;
          if (sprite)
            ctx.drawImage(sprite, proj.x, proj.y, proj.width, proj.height);
          else {
            ctx.fillStyle = proj.type === "special" ? "#ffa500" : "#00ff00";
            ctx.fillRect(proj.x, proj.y, proj.width, proj.height);
          }
        }
        // Enemy projectiles
        for (let i = gameState.enemyProjectiles.length - 1; i >= 0; i--) {
          const proj = gameState.enemyProjectiles[i];
          proj.x -= proj.speed * (gameState.deltaTime / 16);
          if (proj.x + proj.width < 0) {
            gameState.enemyProjectiles.splice(i, 1);
            continue;
          }
          // tạm thời kẻ địch vẫn dùng đạn vẽ đơn giản (có thể thay bằng ảnh riêng nếu thích)
          ctx.fillStyle = "#ff0000";
          ctx.fillRect(proj.x, proj.y, proj.width, proj.height);
        }
      }

      // ========== GAME ACTIONS ==========
      function playerAttack() {
        if (!gameState.running) return;
        const p = gameState.player;
        gameState.projectiles.push({
          x: p.x + p.width,
          y: p.y + p.height / 2 - 5,
          width: 20,
          height: 10,
          speed: 18,
          damage: 999,
          type: "normal",
        });
      }

      function specialAttack() {
        if (!gameState.running || gameState.score < 30) return;
        const p = gameState.player;
        for (let i = -2; i <= 2; i++) {
          gameState.projectiles.push({
            x: p.x + p.width,
            y: p.y + p.height / 2 - 7 + i * 12,
            width: 25,
            height: 14,
            speed: 20,
            damage: 999,
            type: "special",
          });
        }
        gameState.score -= 30;
      }

      function activateShield() {
        if (gameState.player.shieldTime <= 0) {
          gameState.player.shield = true;
          gameState.player.shieldTime = 180; // ~3s
          createShieldEffect(
            gameState.player.x + gameState.player.width / 2,
            gameState.player.y + gameState.player.height / 2
          );
        }
      }

      function enemyShoot(enemy) {
        gameState.enemyProjectiles.push({
          x: enemy.x,
          y: enemy.y + enemy.height / 2 - 4,
          width: 15,
          height: 8,
          speed: 10,
          damage: 20,
        });
      }

      // ========== COLLISION DETECTION ==========
      function checkCollisions() {
        const p = gameState.player;
        // Player bullets vs Enemies
        for (let i = gameState.projectiles.length - 1; i >= 0; i--) {
          const proj = gameState.projectiles[i];
          for (let j = gameState.enemies.length - 1; j >= 0; j--) {
            const enemy = gameState.enemies[j];
            if (isColliding(proj, enemy)) {
              gameState.enemies.splice(j, 1);
              gameState.projectiles.splice(i, 1);
              const points = enemy.type === "banana" ? 50 : 10;
              const comboBonus = Math.floor(gameState.combo / 5);
              const totalPoints = points + points * comboBonus * 0.5;
              gameState.score += totalPoints;
              gameState.combo++;
              gameState.lastComboTime = Date.now();
              if (gameState.combo > 1)
                createComboEffect(enemy.x, enemy.y, gameState.combo);
              createExplosion(
                enemy.x + enemy.width / 2,
                enemy.y + enemy.height / 2
              );
              break;
            }
          }
        }
        // Enemy bullets vs Player
        for (let i = gameState.enemyProjectiles.length - 1; i >= 0; i--) {
          const proj = gameState.enemyProjectiles[i];
          if (isColliding(proj, p) && p.invulnerable <= 0) {
            if (!p.shield) {
              p.health -= proj.damage;
              p.invulnerable = 60;
              if (p.health <= 0) gameOver(false);
            }
            gameState.enemyProjectiles.splice(i, 1);
            createExplosion(proj.x, proj.y);
            gameState.combo = 0;
          }
        }
        // Enemies vs Player
        for (let i = gameState.enemies.length - 1; i >= 0; i--) {
          const enemy = gameState.enemies[i];
          if (isColliding(enemy, p) && p.invulnerable <= 0) {
            if (!p.shield) {
              p.health -= 30;
              p.invulnerable = 60;
              if (p.health <= 0) gameOver(false);
            }
            gameState.enemies.splice(i, 1);
            createExplosion(
              enemy.x + enemy.width / 2,
              enemy.y + enemy.height / 2
            );
            gameState.combo = 0;
          }
        }
      }

      function isColliding(a, b) {
        return (
          a.x < b.x + b.width &&
          a.x + a.width > b.x &&
          a.y < b.y + b.height &&
          a.y + a.height > b.y
        );
      }

      // ========== VICTORY CONDITION ==========
      function checkVictory() {
        if (gameState.score >= gameState.victoryPoints) {
          gameState.running = false;
          showVictoryScreen();
        }
      }
      function showVictoryScreen() {
        document.getElementById(
          "victoryScore"
        ).textContent = `Score ${gameState.score}`;
        document.getElementById(
          "victoryMessage"
        ).textContent = `You have collected enough ${gameState.score} energy points and defeated Banana`;
        document.getElementById("victoryScreen").style.display = "flex";
        createVictoryEffects();
      }
      function createVictoryEffects() {
        for (let i = 0; i < 50; i++) {
          setTimeout(() => {
            for (let j = 0; j < 5; j++) {
              const particle = document.createElement("div");
              particle.className = "victory-particle";
              particle.style.left = Math.random() * 100 + "vw";
              particle.style.top = "100vh";
              particle.style.background = ["#ffd700", "#ff69b4", "#00bfff"][
                Math.floor(Math.random() * 3)
              ];
              document.getElementById("victoryScreen").appendChild(particle);
              setTimeout(() => {
                particle.remove();
              }, 3000);
            }
          }, i * 100);
        }
      }

      // ========== EFFECTS ==========
      function createExplosion(x, y) {
        // Nếu có sprite nổ, vẽ sprite; nếu không, dùng particle đơn giản
        if (images.explosion) {
          ctx.save();
          ctx.globalAlpha = 0.9;
          ctx.drawImage(images.explosion, x - 30, y - 30, 60, 60);
          ctx.restore();
        } else {
          for (let i = 0; i < 15; i++) {
            gameState.particles.push({
              x,
              y,
              vx: (Math.random() - 0.5) * 8,
              vy: (Math.random() - 0.5) * 8,
              life: 30,
              color: ["#ff4500", "#ffd700", "#ffffff"][
                Math.floor(Math.random() * 3)
              ],
              size: Math.random() * 3 + 2,
            });
          }
        }
      }

      function createShieldEffect(x, y) {
        for (let i = 0; i < 20; i++) {
          const angle = (i / 20) * Math.PI * 2;
          gameState.particles.push({
            x,
            y,
            vx: Math.cos(angle) * 3,
            vy: Math.sin(angle) * 3,
            life: 40,
            color: "#00bfff",
            size: Math.random() * 2 + 1,
          });
        }
      }

      function createComboEffect(x, y, combo) {
        const el = document.createElement("div");
        el.className = "combo-popup";
        el.textContent = `${combo}x COMBO!`;
        el.style.left = x + "px";
        el.style.top = y + "px";
        document.getElementById("gameScene").appendChild(el);
        setTimeout(() => el.remove(), 1000);
      }

      function updateParticles() {
        for (let i = gameState.particles.length - 1; i >= 0; i--) {
          const p = gameState.particles[i];
          p.x += p.vx * (gameState.deltaTime / 16);
          p.y += p.vy * (gameState.deltaTime / 16);
          p.life--;
          if (p.life <= 0) {
            gameState.particles.splice(i, 1);
            continue;
          }
          ctx.globalAlpha = p.life / 30;
          ctx.fillStyle = p.color;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }

      function updateCombo() {
        if (Date.now() - gameState.lastComboTime > 3000 && gameState.combo > 0)
          gameState.combo = 0;
      }

      // ========== UI & DIALOG ==========
      function updateUI() {
        const hpPercent =
          (gameState.player.health / gameState.player.maxHealth) * 100;
        const victoryPercent =
          (gameState.score / gameState.victoryPoints) * 100;
        document.getElementById("healthBar").style.width = hpPercent + "%";
        document.getElementById("healthText").textContent = `HP: ${Math.round(
          gameState.player.health
        )}/${gameState.player.maxHealth}`;
        document.getElementById("score").textContent = `Score ${Math.round(
          gameState.score
        )}`;
        document.getElementById(
          "combo"
        ).textContent = `Combo: ${gameState.combo}x`;
        document.getElementById(
          "victoryGoal"
        ).textContent = `Objective: ${Math.round(gameState.score)}/${
          gameState.victoryPoints
        } score`;
        document.getElementById("progressBar").style.width =
          victoryPercent + "%";
        document.getElementById("specialBtn").disabled = gameState.score < 30;
        document.getElementById("mobileSpecial").disabled =
          gameState.score < 30;
        const comboEl = document.getElementById("combo");
        if (gameState.combo >= 10) {
          comboEl.style.color = "#ff00ff";
          comboEl.style.textShadow = "0 0 10px #ff00ff";
        } else if (gameState.combo >= 5) {
          comboEl.style.color = "#ffff00";
          comboEl.style.textShadow = "0 0 10px #ffff00";
        } else {
          comboEl.style.color = "#00ff00";
          comboEl.style.textShadow = "2px 2px 4px rgba(0,0,0,0.5)";
        }
        const progressBar = document.getElementById("progressBar");
        if (victoryPercent >= 100)
          progressBar.style.background =
            "linear-gradient(90deg, #ffd700, #ffff00)";
        else if (victoryPercent >= 75)
          progressBar.style.background =
            "linear-gradient(90deg, #00ff00, #00bfff)";
        else if (victoryPercent >= 50)
          progressBar.style.background =
            "linear-gradient(90deg, #ff69b4, #ff1493)";
      }

      function gameOver(victory) {
        gameState.running = false;
        document.getElementById("gameOverText").textContent = victory
          ? "Victory!"
          : "Defeated!";
        document.getElementById("finalScore").textContent = `Score ${Math.round(
          gameState.score
        )}`;
        document.getElementById("gameOver").style.display = "flex";
      }

      // Handle window resize
      window.addEventListener("resize", () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      });
      canvas.addEventListener("contextmenu", (e) => e.preventDefault());

      // document.addEventListener("keydown", (Enter) => {
      //   if (Enter.key === "Enter") {
      //     const ss = document.getElementById("mainGame");
      //     if (ss && ss.style.display !== "none") {
      //       showMainMenu();
      //     }
      //   }
      // });

      // ========== AUTOPLAY CREDITS ON LOAD ==========
      window.addEventListener("load", () => {
        // Ẩn màn hình Start để video không bị che (muốn hiện Start thì bỏ 2 dòng dưới)
        const ss = document.getElementById("startScreen");
        if (ss) ss.style.display = "none";

        try {
          playCredits(); // gọi video mở đầu ngay khi tải trang
        } catch (e) {
          console.warn("Autoplay on load failed:", e);
        }
      });
      (function(){
        // === Tuỳ chỉnh nhanh (đổi số là đổi gameplay) ===
        const PHASE_CONFIG = {
          phase1To2Score: 180,        // đạt điểm này -> vào Phase 2
          boss: {
            hp: 600,                   // máu boss
            touchDamage: 50,
            bulletDamage: 25,
            speed: 1.5,
            width: 160,
            height: 120,
            shootDelay: 900
          },
          minion: { points: 10 },
          banana: { points: 50 }
        };

        // Tạo UI (cảnh báo + thanh máu boss) trong #gameScene
        function ensureBossUI(){
          const root = document.getElementById("gameScene");
          if (!root || document.getElementById("bossWarning")) return;
          const warn = document.createElement("div"); warn.id = "bossWarning";
          warn.textContent = "⚠ BOSS SẮP XUẤT HIỆN!";
          const bar = document.createElement("div");  bar.id = "bossHP";
          const fill = document.createElement("div"); fill.id = "bossHPFill";
          bar.appendChild(fill); root.appendChild(warn); root.appendChild(bar);
        }
        ensureBossUI();

        // Mở rộng state (không phá đồ cũ)
        if (!('phase' in gameState)) {
          gameState.phase = 1;
          gameState.boss = null;
          gameState.bossDead = false;
          gameState.bossLastShot = 0;
        }

        function updateBossHPUI(){
          const bar = document.getElementById('bossHP');
          const fill = document.getElementById('bossHPFill');
          if (!gameState.boss || !bar || !fill){ if(bar) bar.style.display='none'; return; }
          bar.style.display = 'block';
          const pct = Math.max(0, gameState.boss.hp) / PHASE_CONFIG.boss.hp * 100;
          fill.style.width = pct + '%';
        }
        function showBossWarning(){
          const el = document.getElementById('bossWarning'); if (!el) return;
          el.style.display = 'flex'; setTimeout(()=> el.style.display='none', 1800);
        }
        function spawnBoss(){
          if (gameState.boss) return;
          gameState.boss = {
            x: canvas.width + 10,
            y: canvas.height*0.2 + Math.random()*canvas.height*0.5,
            width: PHASE_CONFIG.boss.width, height: PHASE_CONFIG.boss.height,
            speed: PHASE_CONFIG.boss.speed, hp: PHASE_CONFIG.boss.hp,
            type: 'boss', vx: -PHASE_CONFIG.boss.speed, vy: 0, lastShot: 0
          };
          showBossWarning();
        }

        // --- override: spawnEnemies (giữ logic cũ + kích hoạt phase 2) ---
        const _spawnEnemies = typeof spawnEnemies === 'function' ? spawnEnemies : null;
        window.spawnEnemies = function(){
          if (gameState.phase === 1 && gameState.score >= PHASE_CONFIG.phase1To2Score){
            gameState.phase = 2; spawnBoss();
          }
          if (_spawnEnemies) _spawnEnemies(); // vẫn spawn minion/banana như cũ
        };

        // --- override: updateEnemies (vẽ/cập nhật boss & bắn đạn) ---
        const _updateEnemies = typeof updateEnemies === 'function' ? updateEnemies : null;
        window.updateEnemies = function(){
          if (gameState.boss && gameState.boss.hp > 0){
            const b = gameState.boss;
            if (b.x > canvas.width - b.width - 40) b.x += b.vx * (gameState.deltaTime/16);
            else b.y += Math.sin(performance.now()/600) * 1.8;

            if (images.boss) ctx.drawImage(images.boss, b.x, b.y, b.width, b.height);
            else { ctx.fillStyle='#8b0000'; ctx.fillRect(b.x,b.y,b.width,b.height); }

            if (performance.now() - b.lastShot > PHASE_CONFIG.boss.shootDelay){
              gameState.enemyProjectiles.push({
                x:b.x, y:b.y + b.height/2 - 6, width:18, height:12,
                speed:12, damage:PHASE_CONFIG.boss.bulletDamage, from:'boss'
              });
              b.lastShot = performance.now();
            }
            updateBossHPUI();
          }
          if (_updateEnemies) _updateEnemies();
        };

        // --- override: checkCollisions (đạn người chơi trừ máu boss) ---
        const _checkCollisions = typeof checkCollisions === 'function' ? checkCollisions : null;
        window.checkCollisions = function(){
          if (gameState.boss && gameState.boss.hp > 0){
            for (let i = gameState.projectiles.length - 1; i >= 0; i--){
              const proj = gameState.projectiles[i], b = gameState.boss;
              if (proj.x < b.x + b.width && proj.x + proj.width > b.x &&
                  proj.y < b.y + b.height && proj.y + proj.height > b.y){
                gameState.projectiles.splice(i,1);
                b.hp -= proj.damage;          // đạn thường của bạn đang để 999 dmg :contentReference[oaicite:2]{index=2}
                createExplosion(b.x + b.width/2, b.y + b.height/2);
                updateBossHPUI();
                if (b.hp <= 0){ gameState.bossDead = true; setTimeout(()=>{ const bar=document.getElementById('bossHP'); if(bar) bar.style.display='none'; }, 600); }
              }
            }
          }
          if (_checkCollisions) _checkCollisions();

          // Boss chạm player
          if (gameState.boss && gameState.boss.hp > 0){
            const b = gameState.boss, p = gameState.player;
            if (p && p.invulnerable<=0 &&
                p.x < b.x + b.width && p.x + p.width > b.x &&
                p.y < b.y + b.height && p.y + p.height > b.y){
              if (!p.shield){
                p.health -= PHASE_CONFIG.boss.touchDamage;
                p.invulnerable = 60;
                if (p.health <= 0) gameOver(false);
              }
              createExplosion(p.x+p.width/2, p.y+p.height/2);
            }
          }
        };

        // --- override: checkVictory (thắng khi hạ boss) ---
        const _checkVictory = typeof checkVictory === 'function' ? checkVictory : null;
        window.checkVictory = function(){
          if (gameState.phase === 2){
            if (gameState.bossDead) gameOver(true);
          } else if (gameState.score >= PHASE_CONFIG.phase1To2Score){
            gameState.phase = 2; spawnBoss();
          }
        };

        // Reset khi bắt đầu trận mới (giữ nguyên startBattle cũ)
        const _startBattle = typeof startBattle === 'function' ? startBattle : null;
        window.startBattle = function(){
          gameState.phase = 1; gameState.boss = null; gameState.bossDead = false;
          const warn=document.getElementById('bossWarning'); if (warn) warn.style.display='none';
          const bar=document.getElementById('bossHP'); if (bar) bar.style.display='none';
          if (_startBattle) return _startBattle();
        };

        // Bạn có thể sửa live trong console: TWO_PHASE_CONFIG
        window.TWO_PHASE_CONFIG = PHASE_CONFIG;
      })();
    </script>
  </body>
</html>
